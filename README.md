# Hotwire: Dynamic form fields with Turbo

[![Deploy to Heroku](https://www.herokucdn.com/deploy/button.png)][heroku-deploy-app]

[heroku-deploy-app]: https://heroku.com/deploy?template=https://github.com/thoughtbot/hotwire-example-template/tree/hotwire-example-turbo-dynamic-forms

One common problem present in interactive web applications is a need to fetch
content or data from the server.

Imagine a page to collect a shipping information. The form could present text
fields to collect the address' street number, city, and postal code, and lists
of options to collect the state and country.

To start, we'll establish a baseline that renders HTML retrieved over HTTP
without any JavaScript. The form will present the states within the United
States. Next, we'll collect the address' country, which will update the list of
states to choose from.

Once we've established a foundation, we'll progressively enhancement the form's
interactivity to enable the "passcode" field when "passcode protected" is
selected, and disable and hide it otherwise. This version will use full-page
navigations and round-trips to the server to fetch updated HTML, and will work
even when JavaScript is disabled.

Finally, we'll incrementally improve the experience through JavaScript that
controls the "passcode" field without any client-server communication.

The code samples shared in this article omit the majority of the applicationâ€™s
setup. The application's code was generated by executing `rails new`. The rest
of the [source code][] from this article (including a [suite of tests][]) can be
found on GitHub, and is best read [commit-by-commit][].

[source code]: https://github.com/thoughtbot/hotwire-example-template/tree/hotwire-example-turbo-dynamic-forms
[suite of tests]: https://github.com/thoughtbot/hotwire-example-template/tree/hotwire-example-turbo-dynamic-forms/test
[commit-by-commit]: https://github.com/thoughtbot/hotwire-example-template/compare/hotwire-example-turbo-dynamic-forms

## Our starting point

We'll render a form that collects information about `Address` records. We're
interested in the address and whether it's "owned", "leased", or "other". When
it's "leased", we'll require that the submission includes a management phone
number. When it's "other", we'll require a description. Otherwise, both fields
are optional.

A `Address` record's `country` column will default to the United States (that
is, a `country` attribute with a value of `"US"`). We're relying on the
[city-state][] gem to provide our form with a collection of "Country" and
"State" options.

In addition to validations, the `Address` model class defines an
[enumeration][] and some convenience methods to access Countries and States
provided by the `city-state` gem (invoked about through the `CS` class):

[city-state]: https://github.com/loureirorg/city-state/
[enumeration]: https://edgeapi.rubyonrails.org/classes/ActiveRecord/Enum.html

```ruby
class Address < ApplicationRecord
  with_options presence: true do
    validates :line_1
    validates :city
    validates :postal_code
  end

  validates :state, inclusion: { in: -> record { record.states.keys }, allow_blank: true },
                    presence: { if: -> record { record.states.present? } }

  def countries
    CS.countries.with_indifferent_access
  end

  def country_name
    countries[country]
  end

  def states
    CS.states(country).with_indifferent_access
  end

  def state_name
    states[state]
  end
end
```

The `addresses/new` template collects values and submits the `<form>` as a
`POST` request to the `AddresssController#create` action:

```erb
<%# app/views/addresses/new.html.erb %>

<section class="w-full max-w-lg">
  <h1>New address</h1>

  <%= form_with model: @address, class: "flex flex-col gap-2" do |form| %>
    <%= form.label :line_1 %>
    <%= form.text_field :line_1 %>

    <%= form.label :line_2 %>
    <%= form.text_field :line_2 %>

    <%= form.label :city %>
    <%= form.text_field :city %>

    <%= form.label :state %>
    <%= form.select :state, @address.states.invert %>

    <%= form.label :postal_code %>
    <%= form.text_field :postal_code %>

    <%= form.button %>
  <% end %>
</section>
```

![A form collecting information about an Address](https://user-images.githubusercontent.com/2575027/150692333-295fb94f-8f02-4f48-a766-f8c485e8ecc7.png)

`Address` records are managed by a conventional `AddressesController` class:

```ruby
# app/controllers/addresses_controller.rb

class AddressesController < ApplicationController
  def new
    @address = Address.new
  end

  def create
    @address = Address.new address_params

    if @address.save
      redirect_to address_url(@address)
    else
      render :new, status: :unprocessable_entity
    end
  end

  def show
    @address = Address.find params[:id]
  end

  private

  def address_params
    params.require(:address).permit(
      :line_1,
      :line_2,
      :city,
      :state,
      :postal_code,
    )
  end
end
```

When the submission is valid, the record is created, the data is written to the
database, and the controller serves an [HTTP redirect response][redirect] to the
`addresses#show` route. When the submission's data is invalid the controller
re-renders the `bulidings#new` template, responds with a [422 Unprocessable
Entity][422].

[422]: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/422
[redirect]: https://developer.mozilla.org/en-US/docs/Web/HTTP/Redirections
